<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estatistica - Vaccinus</title>

    <link rel="stylesheet" href="css/style_est.css">
    <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400&display=swap" rel="stylesheet">

    <!-- script do google charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- <script type="text/javascript" src="funcoes.js"></script> -->

    <style>
        /* Classes CSS para exemplos de alertas */

        .normal {
            color: #00c555;
        }

        .alerta-alto {
            color: #FF1616;            
        }

        .alerta-baixo {
            color: #86EAE9;            
        }
        .risco-alto {
            color: #F45D00;            
        }

        .risco-baixo {
            color: #2C92D5;            
        }
    </style>
</head>

<body onload="atualizacaoPeriodica(), obterMedia()">
    <!--header inicio-->

    <header class="header" id="header">
        <div class="l-navbar" id="nav-bar">
            <nav class="nav">
                <div>
                    <a href="index.html" class="nav_logo">
                        <img src="img/logo_sem.png" class='nav_logo-icon'>
                        <span class="nav_logo-name">accinus</span>
                    </a>
                    <div class="nav_list">
                        <a href="grafico-chartjs.html" class="nav_link">
                            <i class='bx bx-grid-alt nav_icon'></i>
                            <span class="nav_name">Resumo</span>
                        </a>
                    </div>
                    <div class="nav_list">
                        <a href="tempo-real.html" class="nav_link-est">
                            <i class='bx bx-stats nav_icon-est'></i></i>
                            <span-um class="nav_name">Estatisticas</span>
                        </a>
                    </div>
                    <div class="nav_list">
                        <a href="relatorio.html" class="nav_link">
                            <i class='bx bx-folder nav_icon'></i></i>
                            <span class="nav_name">Relátorio</span>
                        </a>
                    </div>
                    <div class="nav_list">
                        <a href="configuracoes2.html" class="nav_link">
                            <i class='bx bxs-cog nav_icon'></i></i>
                            <span class="nav_name">Configurações</span>
                        </a>
                        <section class="section">
                            <div class="estatistica_box">
                                <div class="estatistica_item">
                                    <i class='bx bx-wifi-off'></i>
                                    <span>Conexão perdida</span>
                                    <p>Se conecte para visualizar seus dados</p>
                                </div>
                            </div>
                        </section>

                        <section class="section-not">
                            <div class="notificacao-box">
                                <div class="notificacao_item">
                                    <i class='bx bxs-bell-ring' style="color: rgb(151, 151, 151);"></i> <br><br> <br>
                                    <span style="color: rgb(151, 151, 151);">Notificações</span>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </nav>
        </div>
        <div class="box"></div>
        <div class="box linha-vertical"></div>
    </header>

    <!-- <div class="header">
        <div class="container">
            <h1 class="titulo"><span class="highlight">Projeto</span> IoT Revolucionário</h1>
            <div class="usuario">
                <h3>Olá, <b id="b_usuario"></b></h3>
            </div>
            <div class="nav">
                <ul>
                    <li><a href="grafico-chartjs.html">Gráfico de histórico recente</a></li>
                    <li><a href="#" class="highlight" onclick="logoff()">LOGOUT</a></li>
                </ul>
            </div>
        </div>
    </div> -->
    <!--header fim-->

    <section class="section-plano">

        <div class="plano_box">
            <button class="plano_box">
                <div class="plano_item">
                    <i class='bx bx-right-arrow-alt'></i> <br>
                    <span>Faça um upgrade do seu plano!</span>
                </div>
            </button>
        </div>

    </section>

    <section>
        <div class="container">
            <h3>Olá, <b id="b_usuario"></b></h3>
            <span>O que está acontecendo?</span>

            <section class="section-data">
                <div class="data_item">
                    <span>Container 1</span>
                </div>
                <div class="data_box">
                    <p>Febre Amarela</p>
                </div>

                <div class="data_box1">
                    <div class="data_item1">
                        <span>Container 2</span>
                    </div>
                    <p>Dengue</p>
                </div>

                <div class="data_box2">
                    <div class="data_item2">
                        <span>Container 3</span>
                    </div>
                    <p>Covid-19</p>
                </div>

                <div class="data_box3">
                    <div class="data_item3">
                        <span>Container 4</span>
                    </div>
                    <p>Raiva</p>
                </div>
        </div>
    </section>

    <section class="section-graficos">

        <div class="grafico_box">
        <div class="grafico_item1">
            <span name="namecaminhao" id="fkSensor" value="1"></span>

            <div class="valores">
                <div class="temp_spandiv">
                    Temperatura:
                </div>
                
                <div class="valor" id="div_temperatura">Temperatura sendo obtida...</div>
                <!-- <div class="valor" id="div_umidade">Umidade sendo obtida...</div> -->
            </div>
            <div class="alertas">
                <div class="alerta" id="div_alerta_temperatura"> </div>
                <!-- <div class="alerta_umidd" id="div_alerta_umidade"></div> -->
            </div>

        </div>
    </div>
        
        <div class="grafico_box1">
            <div class="grafico_item1">
                <span name="namecaminhao" id="fkSensor" value="2"></span>
                <div class="temp_spandiv">
                    Temperatura:
                </div>

                <div class="valores">
                    <div class="valor" id="div_temperatura2">Temperatura sendo obtida...</div>
                    <!-- <div class="valor" id="div_umidade2">Umidade sendo obtida...</div> -->
                </div>

                <div class="alertas">
                    <div class="alerta" id="div_alerta_temperatura2"></div>
                    <!-- <div class="alerta_umidd" id="div_alerta_umidade2"></div> -->
                </div>
            </div>
        </div>

        <div class="grafico_box2">
            <div class="grafico_item2">
                <span name="namecaminhao" id="fkSensor" value="3"></span>
                <div class="temp_spandiv">
                    Temperatura:
                </div>

                <div class="valores">
                    <div class="valor" id="div_temperatura3">Temperatura sendo obtida...</div>
                    <!-- <div class="valor" id="div_umidade3">Umidade sendo obtida...</div> -->
                </div>
                <div class="alertas">
                    <div class="alerta" id="div_alerta_temperatura3"></div>
                    <!-- <div class="alerta_umidd" id="div_alerta_umidade3"></div> -->
                </div>
            </div>
        </div>

        <div class="grafico_box3">
            <div class="grafico_item3">
                <span name="namecaminhao" id="fkSensor" value="4"></span>
                <div class="temp_spandiv">
                    Temperatura:
                </div>

                <div class="valores">
                    <div class="valor" id="div_temperatura4">Temperatura sendo obtida...</div>
                    <!-- <div class="valor" id="div_umidade4">Umidade sendo obtida...</div> -->
                </div>

                <div class="alertas">
                    <div class="alerta" id="div_alerta_temperatura4"></div>
                    <!-- <div class="alerta_umidd" id="div_alerta_umidade4"></div> -->
                </div>
            </div>
        </div>

    </section>

    <section class="section-numeros">
        <div class="numero_box">
            <div class="numero_item">
                <i class='bx bx-test-tube'></i>
                <span>Febre Amarela</span>
                <p>Container 1</p>

                <div class="situacao">
                
                    <p>Situação</p>
                    <span>Ativo</span>
                    <!-- <i class='bx bx-trending-down' ></i> -->
                </div>

                <div class="Aumento">                
                    <p>Agora</p>
                    <span name="namecaminhao" id="fkSensor" value="1"></span>
                    <div class="valores">
                        <div id="temp_agora">Aguarde...</div>
                    </div>
                </div>

                <div class="Quantidade">                
                    <p>Anterior</p>
                    <span name="namecaminhao" id="fkSensor" value="1"></span>
                    <div class="valores">
                        <div id="temp_anterior">Aguarde...</div>
                    </div>
                </div>

                <div class="Perdidas">                
                    <p>Mínima</p>
                    <span name="namecaminhao" id="fkSensor" value="1"></span>
                    <div class="valores">
                        <div id="temp_min">Aguarde...</div>
                    </div>
                </div>

                <div class="Utilizaveis">                
                    <p>Máxima</p>
                    <span name="namecaminhao" id="fkSensor" value="1"></span>
                    <div class="valores">
                        <div id="temp_max">Aguarde...</div>
                    </div>
                </div>
            </div>     
                    
        
        </div>
    </section>



</body>


<script>

    let usuario;

    verificar_autenticacao();

    // só mexer se quiser alterar o tempo de atualização
    // ou se souber o que está fazendo!
    function atualizacaoPeriodica() {
        obterdadosporcaminhao(1);
        obterdadosporcaminhao(2);
        obterdadosporcaminhao(3);
        obterdadosporcaminhao(4);
        setTimeout(atualizacaoPeriodica, 5000);
    }

    

    function obterdadosporcaminhao(fkSensor) {
        //aguardar();
        fetch(`/leituras/tempo-real/${fkSensor}`)
        .then(resposta => {

            if (resposta.ok) {
                resposta.json().then(function (resposta) {

                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

                    // aqui, após registro. use os nomes 
                    // dos atributos que vem no JSON 
                    var dados = {
                        temperatura: resposta.temp_atual,
                        // umidade: resposta.umidade
                    }

                    alertar(resposta.temp_atual, fkSensor);
                    atualizarTela(dados, fkSensor);
                });
            } else {

                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
        .catch(function (error) {
                console.error(`Erro na obtenção dos dados do caminhao p/ gráfico: ${error.message}`);
            });
    }

    function obterMedia() {
        //aguardar();
        fetch(`/leituras/estatisticas`)
        .then(resposta => {

            if (resposta.ok) {
                resposta.json().then(function (resposta) {

                    console.log(`Dados recebidos Estatísticas: ${JSON.stringify(resposta)}`);
                    temp_max.innerHTML = resposta.temp_maxima
                    // aqui, após registro. use os nomes 
                    // dos atributos que vem no JSON 
                    // var dados = {
                    //     temperatura: resposta.temp_maxima,
                    //     // umidade: resposta.umidade
                    // }
                    // alertar(resposta.temp_maxima, fkSensor);
                    // atualizarTela(dados, fkSensor);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
        .catch(function (error) {
                console.error(`Erro na obtenção dos dados do caminhao p/ gráfico: ${error.message}`);
            });
    }

    function alertar(temperatura, fkSensor) {
        // padrão para meu alerta
        var limites = {
            max_temperatura: 8,
            min_temperatura: 2,
            risco_frio: 3,
            risco_quente: 7,
        };

        // zerar aviso de mensagem
        var mensagem_temperatura = '';
        // var mensagem_umidade = '';
        var classe_temperatura = 'alerta';
        // var classe_umidade = 'alerta_umidd';

        // comparando
        if (temperatura >= limites.max_temperatura) {
            mensagem_temperatura += 'Temperatura alta demais! <br> <img src="img/alert_max.gif" width="55%">';
            classe_temperatura = 'alerta alerta-alto';
        }
        if (temperatura >= limites.risco_quente && temperatura < limites.max_temperatura) {
            mensagem_temperatura = 'Temperatura alta! <br> <img src="img/alert_risco2.gif" width="55%">';
            classe_temperatura = 'alerta risco-alto';
        }
        if (temperatura <= limites.min_temperatura) {
            mensagem_temperatura = 'Temperatura muito baixa! <br> <img src="img/alert_min.gif" width="55%">';
            classe_temperatura = 'alerta alerta-baixo';
        }
        if (temperatura <= limites.risco_frio && temperatura > limites.min_temperatura) {
            mensagem_temperatura = 'Temperatura baixa! <br> <img src="img/alert_risco1.gif" width="55%">';
            classe_temperatura = 'alerta risco-baixo';
        }
        if (temperatura > limites.risco_frio && temperatura < limites.risco_quente) {
            mensagem_temperatura = 'Temperatura ideal <br> <img src="img/ok.png" width="35%">';
            classe_temperatura = 'alerta normal';
        }

        // escolhendo qual alterar
        var div_temperatura_alterar
        // var div_umidade_alterar

        if (fkSensor == 1) {
            div_temperatura_alterar = div_alerta_temperatura
            // div_umidade_alterar = div_alerta_umidade
        } else if (fkSensor == 2) {
            div_temperatura_alterar = div_alerta_temperatura2
            // div_umidade_alterar = div_alerta_umidade2
        } else if (fkSensor == 3) {
            div_temperatura_alterar = div_alerta_temperatura3
            // div_umidade_alterar = div_alerta_umidade3
        } else if (fkSensor == 4) {
            div_temperatura_alterar = div_alerta_temperatura4
            // div_umidade_alterar = div_alerta_umidade4
        }

        // alterando
        div_temperatura_alterar.innerHTML = mensagem_temperatura;
        div_temperatura_alterar.style = 'text-align: center';
        div_temperatura_alterar.className = classe_temperatura;
    }

    // só altere aqui se souber o que está fazendo!
    function atualizarTela(dados, fkSensor) {
        console.log('iniciando atualização da tela...');
        console.log('Temperatura', dados.temperatura);

        // escolhendo qual alterar
        var div_temperatura_alterar

        if (fkSensor == 1) {
            div_temperatura_alterar = div_temperatura
        } else if (fkSensor == 2) {
            div_temperatura_alterar = div_temperatura2
        } else if (fkSensor == 3) {
            div_temperatura_alterar = div_temperatura3
        } else if (fkSensor == 4) {
            div_temperatura_alterar = div_temperatura4
        }

        div_temperatura_alterar.innerHTML = ` ${dados.temperatura}º`;
        temp_agora.innerHTML = div_temperatura.innerHTML;
        // temp_min.innerHTML = div_temperatura.innerHTML;
        
        setInterval(() => {
            temp_anterior.innerHTML = div_temperatura.innerHTML;
        }, 4500);

        if (temp_min.innerHTML < temp_agora.innerHTML) {
            temp_min.innerHTML = temp_agora.innerHTML;
        }

        if (temp_max.innerHTML > temp_agora.innerHTML) {
            temp_max.innerHTML = temp_agora.innerHTML;
        }

        
        // temp_min.innerHTML = 
        // temp_agora2.innerHTML = div_temperatura.innerHTML;
        // temp_agora3.innerHTML = div_temperatura3.innerHTML;
        // temp_agora4.innerHTML = div_temperatura4.innerHTML;

    }


    function sendData() {
        var http = new XMLHttpRequest();
        http.open('GET', 'http://localhost:9000/api/sendData', false);
        http.send(null);
    }

    setInterval(() => {
        sendData();
    }, 5000);
</script>